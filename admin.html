<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é˜¿èƒ–æ—©é»ï½œå¾Œå°ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
    .nav-btn.active { background-color: white; color: #dc2626; border-bottom: 3px solid #dc2626; }
  </style>
</head>

<body class="min-h-screen flex flex-col">

<header class="bg-red-600 text-white shadow-md sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex items-center justify-between h-16">
      <div class="flex items-center gap-2">
        <i class="fas fa-store-alt text-2xl"></i>
        <h1 class="text-xl font-black">é˜¿èƒ–æ—©é»ï½œå¾Œå°</h1>
      </div>
      <div class="flex h-16">
        <button onclick="switchTab('orders')" id="btn-orders" class="nav-btn active px-4 flex items-center gap-2 font-bold transition-all">
          <i class="fas fa-clipboard-list"></i> è¨‚å–®ç®¡ç†
        </button>
        <button onclick="switchTab('history')" id="btn-history" class="nav-btn px-4 flex items-center gap-2 font-bold transition-all">
          <i class="fas fa-history"></i> è¨‚å–®ç¸½è¡¨
        </button>
        <button onclick="switchTab('menu')" id="btn-menu" class="nav-btn px-4 flex items-center gap-2 font-bold transition-all">
          <i class="fas fa-utensils"></i> èœå–®ç®¡ç†
        </button>
      </div>
    </div>
  </div>
</header>

<main class="flex-grow max-w-7xl mx-auto w-full p-4 md:p-6">

  <section id="panel-orders" class="tab-panel">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-black text-gray-800">å³æ™‚å¾…è™•ç†è¨‚å–®</h2>
      <button onclick="loadPendingOrders()" class="bg-white border px-4 py-2 rounded-lg hover:bg-gray-50 font-bold shadow-sm">
        <i class="fas fa-sync-alt mr-1"></i> é‡æ–°æ•´ç†
      </button>
    </div>
    <div id="status-pending" class="text-gray-500 mb-4 font-bold">è¼‰å…¥ä¸­...</div>
    <div id="pending-tables" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <section id="panel-history" class="tab-panel hidden">
    <div class="bg-white p-6 rounded-2xl shadow-sm border mb-6">
      <div class="flex flex-wrap gap-4 items-end justify-between">
        <div class="flex flex-wrap gap-4">
          <div>
            <label class="block text-xs font-bold text-gray-400 mb-1">ç¯©é¸æ—¥æœŸ</label>
            <select id="hist-filter-date" onchange="applyHistoryFilters()" class="border rounded-lg px-3 py-2 bg-gray-50 outline-none"></select>
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-400 mb-1">äººå“¡/æ¡Œè™Ÿ</label>
            <select id="hist-filter-name" onchange="applyHistoryFilters()" class="border rounded-lg px-3 py-2 bg-gray-50 outline-none"></select>
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-400 mb-1">å“é …</label>
            <select id="hist-filter-item" onchange="applyHistoryFilters()" class="border rounded-lg px-3 py-2 bg-gray-50 outline-none"></select>
          </div>
        </div>
        <div class="flex gap-2">
            <button onclick="loadHistoryData()" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-bold"><i class="fas fa-search"></i> æŸ¥è©¢</button>
            <button onclick="triggerDeleteAllOrders()" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-200">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-left">
          <thead class="bg-gray-50 text-gray-500 text-xs font-bold uppercase tracking-wider">
            <tr>
              <th class="px-6 py-4">æ™‚é–“</th>
              <th class="px-6 py-4">æ¡Œè™Ÿ/äººå“¡</th>
              <th class="px-6 py-4">å“é …</th>
              <th class="px-6 py-4 text-right">å–®åƒ¹</th>
              <th class="px-6 py-4 text-center">æ•¸é‡</th>
              <th class="px-6 py-4 text-right">å°è¨ˆ</th>
              <th class="px-6 py-4 text-center">ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody id="history-tbody" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>
      <div class="bg-gray-50 p-4 flex justify-end gap-8 text-sm">
        <div class="font-bold text-gray-500">ç¸½è¨ˆæ•¸é‡: <span id="hist-total-qty" class="text-gray-900 text-lg">0</span></div>
        <div class="font-bold text-gray-500">ç¸½è¨ˆé‡‘é¡: <span id="hist-total-amt" class="text-red-600 text-lg">$0</span></div>
      </div>
    </div>
  </section>

  <section id="panel-menu" class="tab-panel hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-black text-gray-800">èœå–®å“é …ç®¡ç†</h2>
      <button onclick="openMenuModal('add')" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold shadow-md">
        <i class="fas fa-plus mr-1"></i> æ–°å¢å“é …
      </button>
    </div>
    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
      <table class="w-full text-left">
        <thead class="bg-gray-50 text-gray-500 text-xs font-bold uppercase tracking-wider">
          <tr>
            <th class="px-6 py-4">åˆ†é¡</th>
            <th class="px-6 py-4">åç¨±</th>
            <th class="px-6 py-4 hidden md:table-cell">æè¿°</th>
            <th class="px-6 py-4">åƒ¹æ ¼</th>
            <th class="px-6 py-4 text-center">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="admin-menu-tbody" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </section>
</main>

<div id="modal-menu-edit" class="fixed inset-0 bg-black/50 hidden z-[60] flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
    <div class="p-6 border-b flex justify-between items-center">
      <h3 id="menu-modal-title" class="text-xl font-black">ç·¨è¼¯å“é …</h3>
      <button onclick="closeMenuModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>
    <div class="p-6 space-y-4">
      <input type="hidden" id="menu-row-id">
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">åˆ†é¡</label>
        <input id="menu-cat" type="text" class="w-full border rounded-xl px-4 py-2 outline-none focus:border-red-500" placeholder="ä¾‹å¦‚ï¼šè›‹é¤…">
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">åç¨±</label>
        <input id="menu-name" type="text" class="w-full border rounded-xl px-4 py-2 outline-none focus:border-red-500" placeholder="ä¾‹å¦‚ï¼šèµ·å¸è›‹é¤…">
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">æè¿°</label>
        <input id="menu-desc" type="text" class="w-full border rounded-xl px-4 py-2 outline-none focus:border-red-500" placeholder="ç”¢å“ç°¡ä»‹">
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-1">åƒ¹æ ¼</label>
        <input id="menu-price" type="number" class="w-full border rounded-xl px-4 py-2 outline-none focus:border-red-500" placeholder="0">
      </div>
    </div>
    <div class="p-6 bg-gray-50 flex gap-3">
      <button onclick="closeMenuModal()" class="flex-1 py-3 font-bold text-gray-500 bg-white border rounded-xl">å–æ¶ˆ</button>
      <button onclick="triggerMenuSave()" class="flex-1 py-3 font-bold text-white bg-red-600 rounded-xl">å„²å­˜</button>
    </div>
  </div>
</div>

<script>
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycby7pD3O3PgpIfwjjUHkY8L-Oyr5IadRA7YZ1NEDOZf35rejAfALmI8EoMuxyc8ush2gDw/exec";
  
  let menuData = [];
  let historyData = [];
  let tableButtonState = {};

  // é€šç”¨å‘¼å« API å‡½å¼ (å·²ç§»é™¤å¯†ç¢¼é©—è­‰é‚è¼¯)
  async function callApi(payload) {
    const res = await fetch(GAS_API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  // é¢æ¿åˆ‡æ›
  function switchTab(tab) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`panel-${tab}`).classList.remove('hidden');
    document.getElementById(`btn-${tab}`).classList.add('active');
    
    if(tab === 'orders') loadPendingOrders();
    if(tab === 'history') loadHistoryData();
    if(tab === 'menu') loadAdminMenu();
  }

  // --- 1. è¨‚å–®ç®¡ç† ---
  async function loadPendingOrders() {
    const status = document.getElementById("status-pending");
    status.innerText = "æ­£åœ¨é€£ç·šä¼ºæœå™¨...";
    try {
      const res = await callApi({ action: "getPendingOrdersMerged" });
      if(res.ok) {
        const list = res.data || [];
        status.innerText = list.length === 0 ? "ç›®å‰æ²’æœ‰å¾…è™•ç†è¨‚å–® âœ…" : `ç›®å‰æœ‰ ${list.length} æ¡Œè¨‚å–®å¾…è™•ç†`;
        renderPendingTables(list);
      }
    } catch(e) { status.innerText = "é€£ç·šå¤±æ•—"; }
  }

  function renderPendingTables(data) {
    const root = document.getElementById("pending-tables");
    root.innerHTML = "";
    data.forEach(t => {
      const isServed = (t.status === "served");
      const itemsHtml = (t.items||[]).map(x => `
        <div class="flex justify-between py-2 border-b border-gray-50 text-sm">
          <span><span class="font-bold">${x.item}</span> <span class="text-red-500">x${x.qty}</span></span>
          <span class="text-gray-400">$${x.subtotal}</span>
        </div>`).join("");

      const card = document.createElement("div");
      card.className = `p-5 rounded-3xl shadow-lg border-2 transition-all ${isServed ? 'bg-orange-50 border-orange-400' : 'bg-white border-white'}`;
      card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
          <div class="text-2xl font-black">æ¡Œè™Ÿ ${t.table}</div>
          <button onclick="handleOrderAction('${t.table}', '${isServed ? 'completed' : 'served'}')" 
            class="px-5 py-2 rounded-xl font-bold text-white shadow-md ${isServed ? 'bg-blue-600' : 'bg-green-600'}">
            ${isServed ? 'ğŸ’° çµå¸³' : 'ğŸšš é€é¤'}
          </button>
        </div>
        <div class="space-y-1 mb-4">${itemsHtml}</div>
        <div class="text-right font-black text-xl text-red-600">Total $${t.total}</div>
      `;
      root.appendChild(card);
    });
  }

  async function handleOrderAction(table, status) {
    if(status === 'completed' && !confirm(`æ¡Œè™Ÿ ${table} ç¢ºèªçµå¸³ï¼Ÿ`)) return;
    const res = await callApi({ action: "markTableStatus", table: table, status: status });
    if(res.ok) loadPendingOrders();
  }

  // --- 2. è¨‚å–®ç¸½è¡¨ ---
  async function loadHistoryData() {
    const tbody = document.getElementById('history-tbody');
    tbody.innerHTML = '<tr><td colspan="7" class="py-10 text-center"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</td></tr>';
    
    const res = await callApi({ action: "getOrderHistory" }); // è«‹ç¢ºä¿ GS æœ‰å°æ‡‰ getOrderHistory
    if(res.ok) {
      historyData = res.data;
      initHistoryFilters();
      applyHistoryFilters();
    } else {
        // è‹¥å¾Œç«¯æš«ä¸æ”¯æ´ getOrderHistoryï¼Œæ­¤è™•æœƒå ±éŒ¯ï¼Œéœ€åœ¨å¾Œç«¯è£œä¸Šè©² function
        tbody.innerHTML = '<tr><td colspan="7" class="py-10 text-center text-red-400">ç„¡æ³•ç²å–æ­·å²è³‡æ–™ï¼Œè«‹ç¢ºèªå¾Œç«¯åŠŸèƒ½</td></tr>';
    }
  }

  function initHistoryFilters() {
    const dates = new Set(), items = new Set(), names = new Set();
    historyData.forEach(r => {
      const d = new Date(r.time);
      dates.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
      items.add(r.item);
      names.add(r.table || r.name);
    });
    
    const fillSel = (id, set, label) => {
        document.getElementById(id).innerHTML = `<option value="all">æ‰€æœ‰${label}</option>` + 
        [...set].sort().reverse().map(v => `<option value="${v}">${v}</option>`).join('');
    };
    fillSel('hist-filter-date', dates, 'æ—¥æœŸ');
    fillSel('hist-filter-item', items, 'å“é …');
    fillSel('hist-filter-name', names, 'æ¡Œè™Ÿ/äººå“¡');
  }

  function applyHistoryFilters() {
    const dVal = document.getElementById('hist-filter-date').value;
    const iVal = document.getElementById('hist-filter-item').value;
    const nVal = document.getElementById('hist-filter-name').value;
    
    const filtered = historyData.filter(r => {
      const d = new Date(r.time);
      const rD = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      return (dVal === 'all' || rD === dVal) && 
             (iVal === 'all' || r.item === iVal) && 
             (nVal === 'all' || (r.table || r.name) === nVal);
    });

    const tbody = document.getElementById('history-tbody');
    let tQty = 0, tAmt = 0;
    
    tbody.innerHTML = filtered.map(r => {
      tQty += Number(r.qty); tAmt += Number(r.subtotal);
      return `<tr class="border-b text-sm">
        <td class="px-6 py-4 text-gray-400">${new Date(r.time).toLocaleString()}</td>
        <td class="px-6 py-4 font-bold">${r.table || r.name}</td>
        <td class="px-6 py-4">${r.item}</td>
        <td class="px-6 py-4 text-right">$${r.price}</td>
        <td class="px-6 py-4 text-center">${r.qty}</td>
        <td class="px-6 py-4 text-right font-bold">$${r.subtotal}</td>
        <td class="px-6 py-4 text-center"><span class="px-2 py-1 rounded-full text-xs bg-gray-100">${r.status}</span></td>
      </tr>`;
    }).join('');
    
    document.getElementById('hist-total-qty').innerText = tQty;
    document.getElementById('hist-total-amt').innerText = `$${tAmt}`;
  }

  async function triggerDeleteAllOrders() {
    if(!confirm("è­¦å‘Šï¼é€™å°‡åˆªé™¤è©¦ç®—è¡¨ä¸­ã€Œæ‰€æœ‰ã€è¨‚å–®è³‡æ–™ï¼Œç¢ºå®šåŸ·è¡Œï¼Ÿ")) return;
    const res = await callApi({ action: "deleteAllOrders" });
    if(res.ok) loadHistoryData();
  }

  // --- 3. èœå–®ç®¡ç† ---
  async function loadAdminMenu() {
    const res = await callApi({ action: "getMenu" });
    if(!res.ok) return;
    menuData = res.data;
    const tbody = document.getElementById('admin-menu-tbody');
    tbody.innerHTML = menuData.map(m => `
      <tr class="border-b">
        <td class="px-6 py-4 font-bold text-orange-600">${m.category}</td>
        <td class="px-6 py-4">${m.name}</td>
        <td class="px-6 py-4 hidden md:table-cell text-xs text-gray-400 truncate max-w-xs">${m.desc}</td>
        <td class="px-6 py-4 font-bold">$${m.price}</td>
        <td class="px-6 py-4 text-center">
            <button onclick="openMenuModal('edit', ${m.id})" class="text-blue-500 mr-3"><i class="fas fa-edit"></i></button>
            <button onclick="deleteMenuItem(${m.id})" class="text-red-400"><i class="fas fa-trash-alt"></i></button>
        </td>
      </tr>`).join('');
  }

  function openMenuModal(mode, id = null) {
    const modal = document.getElementById('modal-menu-edit');
    modal.classList.remove('hidden');
    if(mode === 'add') {
      document.getElementById('menu-modal-title').innerText = "æ–°å¢å“é …";
      document.getElementById('menu-row-id').value = "";
      ['cat','name','desc','price'].forEach(f => document.getElementById(`menu-${f}`).value = "");
    } else {
      const item = menuData.find(m => m.id === id);
      document.getElementById('menu-modal-title').innerText = "ç·¨è¼¯å“é …";
      document.getElementById('menu-row-id').value = item.id;
      document.getElementById('menu-cat').value = item.category;
      document.getElementById('menu-name').value = item.name;
      document.getElementById('menu-desc').value = item.desc;
      document.getElementById('menu-price').value = item.price;
    }
  }

  function closeMenuModal() { document.getElementById('modal-menu-edit').classList.add('hidden'); }

  async function triggerMenuSave() {
    const payload = {
      action: document.getElementById('menu-row-id').value ? "editMenuItem" : "addMenuItem",
      id: document.getElementById('menu-row-id').value,
      category: document.getElementById('menu-cat').value,
      name: document.getElementById('menu-name').value,
      desc: document.getElementById('menu-desc').value,
      price: Number(document.getElementById('menu-price').value)
    };
    const res = await callApi(payload);
    if(res.ok) { closeMenuModal(); loadAdminMenu(); }
  }

  async function deleteMenuItem(id) {
    if(!confirm("ç¢ºå®šåˆªé™¤æ­¤å“é …ï¼Ÿ")) return;
    const res = await callApi({ action: "deleteMenuItem", id: id });
    if(res.ok) loadAdminMenu();
  }

  window.onload = loadPendingOrders;
</script>

</body>
</html>
