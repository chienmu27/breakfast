<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>阿胖早點｜後台管理系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen">

<script>
  // 請確保此網址正確
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycby7pD3O3PgpIfwjjUHkY8L-Oyr5IadRA7YZ1NEDOZf35rejAfALmI8EoMuxyc8ush2gDw/exec";
</script>

<div id="login-view" class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-md rounded-2xl shadow p-6 border">
    <div class="text-2xl font-black text-red-600 mb-2">阿胖早點｜後台</div>
    <div class="text-gray-600 mb-6">請輸入密碼登入</div>
    <input id="pwd" type="password" class="w-full border rounded-xl px-4 py-3 focus:outline-none focus:ring" placeholder="輸入後台密碼" />
    <button onclick="login()" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl">登入</button>
    <div id="login-msg" class="text-center text-red-600 mt-4 font-bold"></div>
  </div>
</div>

<div id="admin-view" class="hidden">
  <header class="bg-red-600 text-white p-4 shadow sticky top-0 z-50">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <h1 class="text-xl font-bold">阿胖早點｜訂單管理</h1>
      <div class="flex gap-2">
        <button onclick="loadData()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold">重新整理</button>
        <button onclick="logout()" class="bg-black/20 hover:bg-black/30 px-4 py-2 rounded-lg font-bold">登出</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4">
    <div id="status" class="text-gray-600 mb-4"></div>
    <div id="tables" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </main>
</div>

<script>
  let LOGGED_IN = false;
  let SESSION_TOKEN = "";
  let lastPendingCount = 0;
  // 用來記錄每一桌按鈕目前的顯示狀態：'served' (待送餐) 或 'completed' (待結帳)
  let tableButtonState = {}; 

  function money(n){ return "$" + Number(n||0); }

  function fmtTime(v){
    if(!v) return "";
    try{
      const d = new Date(v);
      if(isNaN(d.getTime())) return "";
      const pad = x => String(x).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }catch(e){ return ""; }
  }

  async function api(payload){
    if(LOGGED_IN && SESSION_TOKEN) payload.token = SESSION_TOKEN;
    const res = await fetch(GAS_API_URL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function login(){
    const pwd = document.getElementById("pwd").value.trim();
    if(!pwd) return;
    try{
      const data = await api({ action:"adminLogin", password: pwd });
      if(data && data.ok){
        LOGGED_IN = true;
        SESSION_TOKEN = pwd;
        document.getElementById("login-view").classList.add("hidden");
        document.getElementById("admin-view").classList.remove("hidden");
        loadData();
        setInterval(checkNewOrders, 5000);
      }else{
        document.getElementById("login-msg").innerText = "密碼錯誤";
      }
    }catch(err){ alert("登入失敗"); }
  }

  function logout(){
    location.reload();
  }

  async function loadData(){
    if(!LOGGED_IN) return;
    document.getElementById("status").innerText = "載入中...";
    try{
      const data = await api({ action:"getPendingOrdersMerged" });
      if(data && data.ok){
        const list = data.data || [];
        lastPendingCount = list.length;
        document.getElementById("status").innerText = list.length === 0 ? "目前沒有訂單 ✅" : `目前有 ${list.length} 桌訂單`;
        renderTables(list);
      }
    }catch(err){ console.error(err); }
  }

  function renderTables(data){
    const root = document.getElementById("tables");
    root.innerHTML = "";

    data.forEach(t=>{
      // 如果後端狀態是 served，前端按鈕就預設顯示「結帳」
      if (!tableButtonState[t.table]) {
        tableButtonState[t.table] = (t.status === "served") ? "completed" : "served";
      }

      const itemsHtml = (t.items||[]).map(x=>`
        <div class="flex justify-between border-b py-2 text-sm">
          <div><span class="font-bold">${x.item}</span> <span class="text-gray-400">x${x.qty}</span></div>
          <div class="font-bold text-red-600">${money(x.subtotal)}</div>
        </div>
      `).join("");

      const isWaitingCheckout = tableButtonState[t.table] === "completed";

      const el = document.createElement("div");
      el.className = `rounded-2xl shadow-sm border p-4 transition-colors ${isWaitingCheckout ? 'bg-orange-50 border-orange-200' : 'bg-white border-gray-200'}`;

      el.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="text-xl font-black">桌號 ${t.table}</div>
          <button id="btn-${t.table}" 
            onclick="handleTableAction('${t.table}')"
            class="font-bold px-6 py-2 rounded-xl transition-all ${isWaitingCheckout ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}">
            ${isWaitingCheckout ? '結帳' : '送餐'}
          </button>
        </div>
        <div class="text-xs text-gray-400 mb-3">下單時間：${fmtTime(t.time)}</div>
        <div class="space-y-1">${itemsHtml}</div>
        <div class="flex justify-between mt-4 pt-3 border-t">
          <div class="font-bold text-gray-700">總計</div>
          <div class="font-black text-xl text-red-600">${money(t.total)}</div>
        </div>
      `;
      root.appendChild(el);
    });
  }

  async function handleTableAction(tableNo) {
    const currentState = tableButtonState[tableNo]; // 'served' 或 'completed'
    
    if (currentState === "served") {
      // 點擊「送餐」
      try {
        const res = await api({ action: "markTableStatus", table: tableNo, status: "served" });
        if (res.ok) {
          tableButtonState[tableNo] = "completed"; // 狀態轉為待結帳
          loadData(); // 重新渲染
        }
      } catch (err) { alert("操作失敗"); }
    } else {
      // 點擊「結帳」
      if (!confirm(`桌號 ${tableNo} 確定結帳並清除訂單？`)) return;
      try {
        const res = await api({ action: "markTableStatus", table: tableNo, status: "completed" });
        if (res.ok) {
          delete tableButtonState[tableNo]; // 清除狀態追蹤
          loadData(); // 重新載入，該桌會消失
        }
      } catch (err) { alert("操作失敗"); }
    }
  }

  async function checkNewOrders(){
    if(!LOGGED_IN) return;
    try{
      const data = await api({ action:"getPendingOrdersMerged" });
      if(data && data.ok && data.data.length !== lastPendingCount){
        loadData();
      }
    }catch(err){}
  }

  document.addEventListener("keydown",(e)=>{
    if(e.key==="Enter" && !LOGGED_IN) login();
  });
</script>
</body>
</html>
