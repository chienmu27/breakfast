<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é˜¿èƒ–æ—©é»ï½œå¾Œå°ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">

<script>
  // GAS API ç¶²å€ (è«‹ç¢ºä¿å·²éƒ¨ç½²ç‚ºã€Œæ‰€æœ‰äººã€)
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycby7pD3O3PgpIfwjjUHkY8L-Oyr5IadRA7YZ1NEDOZf35rejAfALmI8EoMuxyc8ush2gDw/exec";
</script>

<div id="login-view" class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-md rounded-2xl shadow-xl p-8 border border-gray-100">
    <div class="text-3xl font-black text-red-600 mb-2">é˜¿èƒ–æ—©é»</div>
    <div class="text-gray-500 mb-8 font-bold">ç®¡ç†å¾Œå°ç™»å…¥</div>
    
    <label class="block text-gray-700 text-sm font-bold mb-2">ç®¡ç†å“¡å¯†ç¢¼ (è¨­å®šå·¥ä½œè¡¨ A2)</label>
    <input id="pwd" type="password" 
           class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 transition-all font-mono" 
           placeholder="è«‹è¼¸å…¥å¾Œå°å¯†ç¢¼" />
    
    <button onclick="login()" 
            class="w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-black py-4 rounded-xl shadow-lg transition-transform active:scale-95">
      ç™»å…¥ç®¡ç†ç³»çµ±
    </button>
    <div id="login-msg" class="text-center text-red-500 mt-4 font-bold min-h-[1.5rem]"></div>
  </div>
</div>

<div id="admin-view" class="hidden">
  <header class="bg-red-600 text-white p-4 shadow-md sticky top-0 z-50">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-2">
        <h1 class="text-xl font-black tracking-tight">é˜¿èƒ–æ—©é»ï½œè¨‚å–®ç®¡ç†</h1>
      </div>
      <div class="flex gap-2">
        <button onclick="loadData()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-bold text-sm">é‡æ–°æ•´ç†</button>
        <button onclick="logout()" class="bg-black/20 hover:bg-black/30 px-4 py-2 rounded-lg font-bold text-sm">ç™»å‡º</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6">
    <div id="status" class="text-gray-500 font-bold mb-6 flex items-center gap-2">
      </div>
    
    <div id="tables" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </main>
</div>

<script>
  let LOGGED_IN = false;
  let SESSION_TOKEN = "";
  let lastPendingCount = 0;
  // è¨˜éŒ„æ¯ä¸€æ¡Œçš„ UI æŒ‰éˆ•ç‹€æ…‹
  let tableButtonState = {}; 

  function money(n){ return "$" + Number(n||0).toLocaleString(); }

  function fmtTime(v){
    if(!v) return "";
    try{
      const d = new Date(v);
      if(isNaN(d.getTime())) return "";
      const pad = x => String(x).padStart(2,"0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }catch(e){ return ""; }
  }

  // å…±ç”¨ API å‘¼å«
  async function api(payload){
    if(LOGGED_IN && SESSION_TOKEN) payload.token = SESSION_TOKEN;
    const res = await fetch(GAS_API_URL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function login(){
    const pwd = document.getElementById("pwd").value.trim();
    if(!pwd) return;
    const msg = document.getElementById("login-msg");
    msg.innerText = "é©—è­‰ä¸­...";
    
    try{
      // å‚³é€å¯†ç¢¼è‡³å¾Œç«¯ adminLoginï¼Œå¾Œç«¯æœƒå¾ã€Œè¨­å®šã€å·¥ä½œè¡¨ A2 æŠ“å–å¯†ç¢¼æ¯”å°
      const data = await api({ action:"adminLogin", password: pwd });
      if(data && data.ok){
        LOGGED_IN = true;
        SESSION_TOKEN = data.token; // å¾Œç«¯å‚³å›çš„ token (é€šå¸¸æ˜¯ A2 çš„å€¼)
        document.getElementById("login-view").classList.add("hidden");
        document.getElementById("admin-view").classList.remove("hidden");
        loadData();
        // æ¯ 10 ç§’æª¢æŸ¥ä¸€æ¬¡æ–°è¨‚å–®
        setInterval(checkNewOrders, 10000);
      }else{
        msg.innerText = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªè©¦ç®—è¡¨è¨­å®š";
      }
    }catch(err){ 
      msg.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS éƒ¨ç½²"; 
    }
  }

  function logout(){
    location.reload();
  }

  async function loadData(){
    if(!LOGGED_IN) return;
    const statusEl = document.getElementById("status");
    statusEl.innerHTML = `<span class="inline-block animate-spin">â³</span> è¼‰å…¥æ•¸æ“šä¸­...`;
    
    try{
      const data = await api({ action:"getPendingOrdersMerged" });
      if(data && data.ok){
        const list = data.data || [];
        lastPendingCount = list.length;
        statusEl.innerText = list.length === 0 ? "ç›®å‰æ²’æœ‰å¾…è™•ç†è¨‚å–® âœ…" : `ç›®å‰æœ‰ ${list.length} æ¡Œè¨‚å–®å¾…è™•ç†`;
        renderTables(list);
      }
    }catch(err){ 
      statusEl.innerText = "ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡æ–™";
    }
  }

  function renderTables(data){
    const root = document.getElementById("tables");
    root.innerHTML = "";

    data.forEach(t=>{
      // å¦‚æœå¾Œç«¯å‚³ä¾†çš„ç‹€æ…‹å·²ç¶“æ˜¯ servedï¼Œå¼·åˆ¶æŒ‰éˆ•ç‹€æ…‹ç‚º completed (çµå¸³)
      if (t.status === "served") {
        tableButtonState[t.table] = "completed";
      } else if (!tableButtonState[t.table]) {
        // è‹¥ç„¡ç´€éŒ„å‰‡é è¨­ç‚ºå¾…é€é¤
        tableButtonState[t.table] = "served";
      }

      const itemsHtml = (t.items||[]).map(x=>`
        <div class="flex justify-between border-b border-gray-100 py-3 text-sm">
          <div>
            <span class="font-bold text-gray-800">${x.item}</span> 
            <span class="text-red-500 font-bold ml-1">x${x.qty}</span>
          </div>
          <div class="font-bold text-gray-400">${money(x.subtotal)}</div>
        </div>
      `).join("");

      const isWaitingCheckout = tableButtonState[t.table] === "completed";

      const el = document.createElement("div");
      el.className = `rounded-3xl shadow-lg border-2 p-5 transition-all duration-300 ${isWaitingCheckout ? 'bg-orange-50 border-orange-400' : 'bg-white border-white'}`;

      el.innerHTML = `
        <div class="flex items-start justify-between mb-4">
          <div>
            <div class="text-2xl font-black text-gray-800">æ¡Œè™Ÿ ${t.table}</div>
            <div class="text-[10px] text-gray-400 uppercase tracking-widest mt-1">ä¸‹å–® ${fmtTime(t.time)}</div>
          </div>
          <button id="btn-${t.table}" 
            onclick="handleTableAction('${t.table}')"
            class="font-black px-6 py-3 rounded-2xl shadow-md transition-all active:scale-90 ${isWaitingCheckout ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}">
            ${isWaitingCheckout ? 'ğŸ’° çµå¸³' : 'ğŸšš é€é¤'}
          </button>
        </div>
        <div class="space-y-1 bg-white/50 rounded-2xl p-2">${itemsHtml}</div>
        <div class="flex justify-between items-center mt-4 px-2">
          <div class="font-bold text-gray-500 uppercase text-xs tracking-wider">Total</div>
          <div class="font-black text-2xl text-red-600">${money(t.total)}</div>
        </div>
      `;
      root.appendChild(el);
    });
  }

  async function handleTableAction(tableNo) {
    const currentState = tableButtonState[tableNo]; 
    
    if (currentState === "served") {
      // é€é¤å‹•ä½œ
      try {
        const res = await api({ action: "markTableStatus", table: tableNo, status: "served" });
        if (res.ok) {
          tableButtonState[tableNo] = "completed"; 
          loadData(); 
        }
      } catch (err) { alert("æ“ä½œå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†"); }
    } else {
      // çµå¸³å‹•ä½œ
      if (!confirm(`æ¡Œè™Ÿ ${tableNo} ç¢ºèªå·²å®Œæˆçµå¸³ä¸¦æ¸…é™¤è¨‚å–®ï¼Ÿ`)) return;
      try {
        const res = await api({ action: "markTableStatus", table: tableNo, status: "completed" });
        if (res.ok) {
          delete tableButtonState[tableNo]; 
          loadData(); 
        }
      } catch (err) { alert("æ“ä½œå¤±æ•—"); }
    }
  }

  // è‡ªå‹•æª¢æŸ¥æœ‰ç„¡è¨‚å–®å¢æ¸›
  async function checkNewOrders(){
    if(!LOGGED_IN) return;
    try{
      const data = await api({ action:"getPendingOrdersMerged" });
      if(data && data.ok && data.data.length !== lastPendingCount){
        loadData();
      }
    }catch(err){}
  }

  document.addEventListener("keydown",(e)=>{
    if(e.key==="Enter" && !LOGGED_IN) login();
  });
</script>
</body>
</html>
