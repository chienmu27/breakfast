<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>阿胖早點 - 中西式精緻早餐</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f9fafb; }
    .category-btn.active { background-color: #ef4444; color: white; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>

<body class="pb-20">

<header class="bg-red-600 text-white p-4 shadow-md sticky top-0 z-50">
  <div class="container mx-auto flex justify-between items-center">
    <h1 class="text-2xl font-bold tracking-wider">阿胖早點 <span class="text-sm font-normal">A-PEN Breakfast</span></h1>
    <div class="flex items-center gap-3">
      <div class="text-sm bg-white/20 px-3 py-1 rounded-full">桌號：<span id="table-no" class="font-bold">-</span></div>
      <div class="relative cursor-pointer" onclick="toggleCart()">
        <i class="fas fa-shopping-cart text-2xl"></i>
        <span id="cart-count" class="absolute -top-2 -right-2 bg-yellow-400 text-red-800 text-xs font-bold px-1.5 py-0.5 rounded-full">0</span>
      </div>
    </div>
  </div>
</header>

<div class="bg-orange-100 p-8 text-center border-b border-orange-200">
  <h2 class="text-3xl font-bold text-gray-800 mb-2">早安！今天要吃點什麼？</h2>
  <p class="text-gray-600 text-lg">雲端菜單，即時更新</p>
</div>

<nav id="category-nav" class="sticky top-[64px] bg-white border-b overflow-x-auto whitespace-nowrap z-40 px-4 py-3 flex gap-2 no-scrollbar">
  <button onclick="filterMenu('all')" class="category-btn active px-4 py-1.5 rounded-full border border-gray-300 text-sm">全部</button>
</nav>

<main class="container mx-auto p-4">
  <div id="loading-spinner" class="text-center py-20 text-gray-500">
    <i class="fas fa-spinner fa-spin text-4xl mb-2"></i>
    <p>正在載入美味菜單...</p>
  </div>
  <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</main>

<div id="cart-sidebar" class="fixed inset-y-0 right-0 w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[60] flex flex-col">
  <div class="p-4 border-b flex justify-between items-center bg-gray-50">
    <h3 class="font-bold text-xl">您的餐點</h3>
    <button onclick="toggleCart()" class="text-gray-500 text-2xl">&times;</button>
  </div>
  <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-4"></div>
  <div class="p-4 border-t bg-gray-50">
    <div class="flex justify-between mb-4">
      <span class="font-bold">總計金額：</span>
      <span class="text-red-600 font-bold text-xl" id="total-price">$0</span>
    </div>
    <button id="btn-submit" onclick="submitOrder()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700">送出訂單</button>
  </div>
</div>
<div id="overlay" onclick="toggleCart()" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"></div>

<script>
  const GAS_API_URL = "您的_GAS_部署網址"; // <--- 請務必換成您部署後的 Web App URL

  let menuData = [];
  let cart = [];
  let TABLE_NO = "";

  function initTable() {
    const url = new URL(location.href);
    TABLE_NO = String(url.searchParams.get("table") || "").trim();
    document.getElementById("table-no").innerText = TABLE_NO || "-";
  }

  // ==============================
  // 從 GAS 抓取菜單
  // ==============================
  async function fetchMenu() {
    try {
      const res = await fetch(`${GAS_API_URL}?action=getMenu`);
      const result = await res.json();
      if (result.ok) {
        menuData = result.data;
        renderCategoryButtons();
        displayMenu('all');
        document.getElementById('loading-spinner').classList.add('hidden');
      } else {
        alert("菜單載入失敗：" + result.message);
      }
    } catch (err) {
      console.error(err);
      alert("無法連接到伺服器");
    }
  }

  function renderCategoryButtons() {
    const nav = document.getElementById('category-nav');
    const categories = [...new Set(menuData.map(item => item.category))];
    categories.forEach(cat => {
      const btn = document.createElement('button');
      btn.className = "category-btn px-4 py-1.5 rounded-full border border-gray-300 text-sm";
      btn.innerText = cat;
      btn.onclick = () => filterMenu(cat);
      nav.appendChild(btn);
    });
  }

  function displayMenu(filter = 'all') {
    const container = document.getElementById('menu-container');
    container.innerHTML = '';
    const filtered = filter === 'all' ? menuData : menuData.filter(item => item.category === filter);

    filtered.forEach(item => {
      container.innerHTML += `
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow">
          <div class="p-4 flex justify-between items-start">
            <div>
              <span class="text-xs bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-bold">${item.category}</span>
              <h3 class="text-lg font-bold mt-1">${item.name}</h3>
              <p class="text-sm text-gray-500 mt-1">${item.desc}</p>
              <p class="text-red-600 font-bold mt-2">$${item.price}</p>
            </div>
            <button onclick="addToCart(${item.id})" class="bg-red-50 text-red-600 w-10 h-10 rounded-full flex items-center justify-center hover:bg-red-600 hover:text-white transition-colors">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>`;
    });
  }

  function addToCart(id) {
    const item = menuData.find(m => m.id === id);
    const inCart = cart.find(c => c.id === id);
    if (inCart) inCart.qty++;
    else cart.push({ ...item, qty: 1 });
    updateCartUI();
  }

  function updateCartUI() {
    const cartItems = document.getElementById('cart-items');
    const cartCount = document.getElementById('cart-count');
    const totalPrice = document.getElementById('total-price');
    cartItems.innerHTML = cart.length === 0 ? '<p class="text-center text-gray-400 mt-10">購物車是空的</p>' : '';
    let total = 0, count = 0;
    cart.forEach(item => {
      total += item.price * item.qty;
      count += item.qty;
      cartItems.innerHTML += `
        <div class="flex justify-between items-center border-b pb-2">
          <div><p class="font-bold">${item.name}</p><p class="text-sm text-gray-500">$${item.price} x ${item.qty}</p></div>
          <div class="flex items-center gap-2">
            <button onclick="changeQty(${item.id}, -1)" class="w-6 h-6 border rounded">-</button>
            <span>${item.qty}</span>
            <button onclick="changeQty(${item.id}, 1)" class="w-6 h-6 border rounded">+</button>
          </div>
        </div>`;
    });
    cartCount.innerText = count;
    totalPrice.innerText = `$${total}`;
  }

  function changeQty(id, delta) {
    const item = cart.find(c => c.id === id);
    item.qty += delta;
    if (item.qty <= 0) cart = cart.filter(c => c.id !== id);
    updateCartUI();
  }

  function toggleCart() {
    document.getElementById('cart-sidebar').classList.toggle('translate-x-full');
    document.getElementById('overlay').classList.toggle('hidden');
  }

  function filterMenu(cat) {
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.innerText === cat || (cat === 'all' && btn.innerText === '全部')) btn.classList.add('active');
    });
    displayMenu(cat);
  }

  async function submitOrder() {
    if (!TABLE_NO) return alert("未取得桌號，請掃碼進入");
    if (cart.length === 0) return alert("購物車是空的");
    const btn = document.getElementById("btn-submit");
    btn.disabled = true; btn.innerText = "送出中...";
    try {
      const payload = { action: "submitOrder", table: TABLE_NO, items: cart.map(x => ({ name: x.name, price: x.price, qty: x.qty })) };
      const res = await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) });
      const data = await res.json();
      if (data.ok) {
        alert("訂單已送出，謝謝！");
        cart = []; updateCartUI(); toggleCart();
      } else alert(data.message);
    } catch (err) { alert("送出失敗"); }
    btn.disabled = false; btn.innerText = "送出訂單";
  }

  initTable();
  fetchMenu();
</script>
</body>
</html>
